---
name: build_container


env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

on:
  push:

jobs:
  build_container:
    runs-on: ubuntu-22.04
    outputs:
      tags: ${{ steps.metadata.outputs.tags }}
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: login to ghcr.io
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: extract metadata
        id: metadata
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: build container
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          labels: ${{ steps.metadata.outputs.labels }}
          tags: ${{ steps.metadata.outputs.tags }}

      - name: debug
        run: echo "${{ steps.metadata.outputs.json }}"

      - name: fail
        run: exit

  build-willow-dist:
    runs-on: ubuntu-22.04
    needs: build_container
    container:
      # ${{ github.ref_name }} = feature/was - / not valid in Docker tag
      #
      # using outputs from docker/metadata-action is ugly because it can be multiple tags
      image: ${{ needs.build_container.outputs.tags }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.github_token }}
      volumes:
        - "${{github.workspace}}:/willow"
    # https://github.com/actions/runner/issues/878#issuecomment-1248930921
    defaults:
      run:
        working-directory: /willow
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: debug
        run: echo ${{ needs.build_container.outputs.tags }}
      - name: ls -al
        run: ls -al
      - name: ls -al /
        run: ls -al /
      # fatal: detected dubious ownership in repository at '/willow'
      - name: id
        run: id
      # ./utils.sh: line 193: idf.py: command not found
      # - name: . $IDF_PATH/export.sh
      #  run: . "$IDF_PATH/export.sh"
      #  need to run it in the same step as utils.sh bloody hell
      - name: env
        run: env
      - name: pwd
        run: pwd
      # need to run with bash to avoid this error:
      # /opt/esp/idf/export.sh: [[: not found
      - name: ./utils.sh setup
        run: ( . "$IDF_PATH/export.sh"; ./utils.sh setup )
        shell: bash
      - name: ./utils.sh build
        run: ( . "$IDF_PATH/export.sh"; ./utils.sh build )
        shell: bash
      - name: ./utils.sh dist
        run: ( . "$IDF_PATH/export.sh"; ./utils.sh dist )
        shell: bash

      - name: upload willow-dist.bin artifact
        uses: actions/upload-artifact@v3
        with:
          name: willow-dist.bin
          path: /willow/build/willow-dist.bin
      - name: upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: willow-partitions
          path: |
            /willow/build/*.bin
            /willow/build/srmodels/srmodels.bin
            /willow/partitions_willow.csv
            /willow/sdkconfig
            !/willow/build/willow-dist.bin

  publish-release:
    if: github.ref_type == 'tag'
    runs-on: ubuntu-22.04
    needs: build-willow-dist
    steps:
      - name: download willow-dist.bin artifact
        uses: actions/download-artifact@v3
        with:
          name: willow-dist.bin
          path: willow-dist.bin.zip

      - name: unzip artifact
        run: unzip willow-dist.bin.zip

      - name: create release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: false
          artifacts: "willow-dist.bin"
